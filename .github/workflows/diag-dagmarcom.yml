name: Diagnose DagmarCom

on:
  workflow_dispatch: {}

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Inspect dagmarcom service on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASS }}
          script: |
            set -e
            set -x
            echo "== docker ps =="
            docker ps
            echo "== docker ps | grep dagmar =="
            docker ps | grep -i dagmar || true
            CID=$(docker ps --filter 'name=dagmar' --format '{{.ID}}' | head -n1)
            if [ -n "$CID" ]; then
              echo "== docker logs (last 200) for $CID =="
              docker logs --tail 200 "$CID" || true
            else
              echo "Nenalezen zadny kontejner s nazvem obsahujicim 'dagmar'"
            fi
            echo "== processes matching dagmar =="
            ps axu | grep dagmar | grep -v grep || true
            echo "== listening processes (node/uvicorn) =="
            lsof -i -P -n | grep -Ei ':(8080|9001|9000|3000)' || true
            echo "== nginx upstream for api.hcasc.cz =="
            sudo cat /etc/nginx/sites-enabled/api.hcasc.cz || true
            echo "== find app.log (limited) =="
            find /srv /opt /var -maxdepth 4 -type f -name 'app.log' 2>/dev/null | head -n 20
            echo "== tail app.log if present =="
            find /srv /opt /var -maxdepth 4 -type f -name 'app.log' 2>/dev/null | head -n 5 | while read -r f; do
              echo "--- $f ---"; tail -n 120 "$f"; done
            echo "== curl /api/settings with default creds =="
            AUTH=$(printf 'admin:+Sin8glov8' | base64)
            curl -v -H "Authorization: Basic $AUTH" https://api.hcasc.cz/api/settings -o /tmp/diag_settings.json || true
            head -c 400 /tmp/diag_settings.json || true
