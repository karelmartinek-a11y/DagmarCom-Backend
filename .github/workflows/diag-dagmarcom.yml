name: Diagnose DagmarCom

on:
  workflow_dispatch: {}

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Inspect dagmarcom service on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASS }}
          script: |
            set -e
            echo "== docker ps =="
            docker ps
            echo "== docker ps | grep dagmar =="
            docker ps | grep -i dagmar || true
            CID=$(docker ps --filter 'name=dagmar' --format '{{.ID}}' | head -n1)
            if [ -n "$CID" ]; then
              echo "== docker logs (last 200) for $CID =="
              docker logs --tail 200 "$CID" || true
            else
              echo "Nenalezen zadny kontejner s nazvem obsahujicim 'dagmar'"
            fi
            echo "== curl /api/settings with default creds =="
            AUTH=$(printf 'admin:+Sin8glov8' | base64)
            curl -v -H "Authorization: Basic $AUTH" https://api.hcasc.cz/api/settings -o /tmp/diag_settings.json || true
            head -c 200 /tmp/diag_settings.json || true
